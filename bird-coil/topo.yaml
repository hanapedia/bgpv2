name: bgpv2-cplane-dev-service
topology:
  nodes:
    # A simple BGP router that peers with Cilium with eBGP.
    router0:
      kind: linux
      image: bird:latest
      binds:
        - configs/bird_router.conf:/etc/bird.conf
      exec:
      - ip addr add 10.0.0.1/32 dev lo
      - ip addr add 10.0.1.1/24 dev net1
      - ip addr add 10.0.2.1/24 dev net2
      - sysctl -w net.ipv4.ip_forward=1
      - iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
      # - ip route add blackhole 10.0.0.0/8
      # Boiler plate to make FRR work
    # Server with Cilium. It shares netns with kind node.
    server0:
      kind: linux
      image: bird:latest
      binds:
        - configs/bird_cp.conf:/etc/bird.conf
      network-mode: container:bgpv2-cplane-dev-service-control-plane
      exec:
      - ip addr add 10.0.1.2/24 dev net0
      - ip route replace default via 10.0.1.1 dev net0
      - ip route add 10.2.0.1/32 dev lo

      # These static routes are needed because Cilium cannot import routes currently.
      # - ip route add 10.0.0.0/8 via 10.0.1.1 dev net0
      # - ip route add 10.0.0.1/32 via 10.0.1.1 dev net0
    # Server with Cilium. It shares netns with kind node.
    server1:
      kind: linux
      image: bird:latest
      binds:
        - configs/bird_worker.conf:/etc/bird.conf
      network-mode: container:bgpv2-cplane-dev-service-worker
      exec:
      - ip addr add 10.0.2.2/24 dev net0
      - ip route replace default via 10.0.2.1 dev net0

      # These static routes are needed because Cilium cannot import routes currently.
      # - ip route add 10.0.0.0/8 via 10.0.2.1 dev net0
      # - ip route add 10.0.0.1/32 via 10.0.2.1 dev net0
  links:
  - endpoints: ["router0:net1", "server0:net0"]
  - endpoints: ["router0:net2", "server1:net0"]
